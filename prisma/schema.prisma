generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                               String                   @id @default(cuid())
  name                             String
  email                            String                   @unique
  phone                            String?
  emailVerified                    DateTime?
  image                            String?
  password                         String
  role                             Role
  status                           UserStatus               @default(ACTIVE)
  disciplineId                     String?
  createdAt                        DateTime                 @default(now())
  updatedAt                        DateTime                 @updatedAt
  lastLoginAt                      DateTime?
  representantId                   String?
  departmentId                     String?
  accounts                         Account[]
  updatedAdvancedSettings          AdvancedSetting[]        @relation("UpdatedAdvancedSettings")
  controlledDeliveryNotes          DeliveryNote[]           @relation("ControlledDeliveryNotes")
  generatedDeliveryNotes           DeliveryNote[]           @relation("GeneratedDeliveryNotes")
  validatedDeliveryNotes           DeliveryNote[]           @relation("ValidatedDeliveryNotes")
  receivedMessages                 Message[]                @relation("ReceivedMessages")
  sentMessages                     Message[]                @relation("SentMessages")
  notifications                    Notification[]
  notificationChains               NotificationChain[]      @relation("NotificationChains")
  createdNotificationChains        NotificationChain[]      @relation("CreatedNotificationChains")
  createdNotificationTemplates     NotificationTemplate[]   @relation("CreatedNotificationTemplates")
  updatedNotificationTemplates     NotificationTemplate[]   @relation("UpdatedNotificationTemplates")
  orders                           Order[]
  partnerClients                   Partner[]                @relation("PartnerRepresentant")
  partner                          Partner?
  validatedPartnerRebates          PartnerRebate[]          @relation("ValidatedPartnerRebates")
  recordedPayments                 Payment[]                @relation("RecordedPayments")
  createdProformas                 Proforma[]               @relation("CreatedProformas")
  userProformas                    Proforma[]               @relation("UserProformas")
  conceivedProjects                Project[]                @relation("ConceptorProjects")
  reviewedProjects                 Project[]                @relation("ReviewedProjects")
  createdRebateRates               RebateRate[]             @relation("CreatedRebateRates")
  authorRebateRates                RebateRate[]             @relation("AuthorRebateRates")
  representantWithdrawals          RepresentantWithdrawal[] @relation("RepresentantWithdrawals")
  validatedRepresentantWithdrawals RepresentantWithdrawal[] @relation("ValidatedRepresentantWithdrawals")
  royalties                        Royalty[]
  sessions                         Session[]
  resolvedAlerts                   StockAlert[]
  createdAlertRules                StockAlertRule[]
  createdIntegrations              StockIntegration[]
  performedStockMovements          StockMovement[]          @relation("StockMovements")
  createdReports                   StockReport[]
  approvedStockRequests            StockRequest[]           @relation("ApprovedStockRequests")
  stockRequests                    StockRequest[]           @relation("StockRequests")
  department                       Department?              @relation(fields: [departmentId], references: [id])
  discipline                       Discipline?              @relation(fields: [disciplineId], references: [id])
  representant                     User?                    @relation("RepresentantAuthors", fields: [representantId], references: [id])
  managedAuthors                   User[]                   @relation("RepresentantAuthors")
  authorWithdrawals                Withdrawal[]             @relation("AuthorWithdrawals")
  validatedWithdrawals             Withdrawal[]             @relation("ValidatedWithdrawals")
  withdrawalRequests               WithdrawalRequest[]
  authoredWorks                    Work[]                   @relation("AuthorWorks")
  conceivedWorks                   Work[]                   @relation("ConceptorWorks")
  reviewedWorks                    Work[]                   @relation("ReviewedWorks")
  workSales                        WorkSale[]
  createdWorkVersions              WorkVersion[]
  workViews                        WorkView[]
  clients                          Client[]                 @relation("UserDepartments")

  @@index([role])
  @@index([status])
  @@index([representantId])
  @@index([disciplineId])
  @@index([departmentId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model WithdrawalRequest {
  id              String    @id @default(cuid())
  userId          String
  amount          Float
  method          String
  phoneNumber     String?
  provider        String?
  bankName        String?
  accountNumber   String?
  accountName     String?
  monerooPayoutId String?   @unique
  status          String    @default("pending")
  failureReason   String?
  processedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  user            User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([monerooPayoutId])
}

model Project {
  id                   String        @id @default(cuid())
  title                String
  description          String?
  objectives           String?
  expectedDeliverables String?
  requiredResources    String?
  timeline             String?
  rejectionReason      String?
  disciplineId         String
  status               ProjectStatus @default(DRAFT)
  submittedAt          DateTime?
  reviewedAt           DateTime?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  concepteurId         String
  reviewerId           String?
  files                String?
  concepteur           User          @relation("ConceptorProjects", fields: [concepteurId], references: [id])
  discipline           Discipline    @relation(fields: [disciplineId], references: [id])
  reviewer             User?         @relation("ReviewedProjects", fields: [reviewerId], references: [id])
  works                Work[]        @relation("ProjectWorks")
}

model Work {
  id                    String             @id @default(cuid())
  title                 String
  description           String?
  isbn                  String             @unique
  internalCode          String?
  price                 Float              @default(0)
  tva                   Float              @default(0.18)
  discountRate          Float?
  stock                 Int                @default(0)
  minStock              Int                @default(10)
  maxStock              Int?
  physicalStock         Int                @default(0)
  category              String?
  targetAudience        String?
  educationalObjectives String?
  contentType           String?
  keywords              String?
  files                 String?
  validationComment     String?
  rejectionReason       String?
  disciplineId          String
  status                WorkStatus         @default(PENDING)
  publishedAt           DateTime?
  publicationDate       DateTime?
  version               String?
  submittedAt           DateTime?
  reviewedAt            DateTime?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @default(now()) @updatedAt
  authorId              String
  reviewerId            String?
  concepteurId          String?
  projectId             String?
  royaltyRate           Float              @default(0)
  royaltyType           RoyaltyType        @default(PERCENTAGE)
  orderItems            OrderItem[]
  partnerRebates        PartnerRebate[]    @relation("WorkPartnerRebates")
  partnerStocks         PartnerStock[]
  proformaItems         ProformaItem[]     @relation("ProformaItemWork")
  rebateRates           RebateRate[]       @relation("WorkRebateRates")
  royalties             Royalty[]
  sales                 Sale[]
  stockAlerts           StockAlert[]
  stockMovements        StockMovement[]
  stockRequestItems     StockRequestItem[]
  author                User               @relation("AuthorWorks", fields: [authorId], references: [id])
  concepteur            User?              @relation("ConceptorWorks", fields: [concepteurId], references: [id])
  discipline            Discipline         @relation(fields: [disciplineId], references: [id])
  project               Project?           @relation("ProjectWorks", fields: [projectId], references: [id])
  reviewer              User?              @relation("ReviewedWorks", fields: [reviewerId], references: [id])
  workDistributions     WorkDistribution[]
  prices                WorkPrice[]        @relation("WorkPrices")
  workSales             WorkSale[]
  versions              WorkVersion[]
  workViews             WorkView[]
  promotions            Promotion[]        @relation("WorkPromotions")

  @@index([status, disciplineId])
  @@index([authorId, status])
  @@index([stock])
  @@index([createdAt])
  @@index([status])
  @@index([authorId])
  @@index([disciplineId])
  @@index([projectId])
  @@index([publishedAt])
}

model StockMovement {
  id               String            @id @default(cuid())
  workId           String
  type             StockMovementType
  quantity         Int
  reason           String?
  reference        String?
  performedBy      String?
  partnerId        String?
  source           String?
  destination      String?
  unitPrice        Float?
  totalAmount      Float?
  isCorrection     Boolean           @default(false)
  correctionReason String?
  createdAt        DateTime          @default(now())
  partner          Partner?          @relation(fields: [partnerId], references: [id])
  performedByUser  User?             @relation("StockMovements", fields: [performedBy], references: [id])
  work             Work              @relation(fields: [workId], references: [id])

  @@index([workId])
  @@index([type])
  @@index([createdAt])
  @@index([partnerId])
  @@index([isCorrection])
  @@index([partnerId, type])
  @@index([partnerId, type, createdAt])
  @@index([workId, type])
}

model Discipline {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  projects    Project[]
  users       User[]
  works       Work[]
}

model Department {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  clients     Client[] @relation("DepartmentClients")
  users       User[]
}

model Sale {
  id        String   @id @default(cuid())
  workId    String
  quantity  Int
  amount    Float
  createdAt DateTime @default(now())
  work      Work     @relation(fields: [workId], references: [id])
}

model Partner {
  id             String          @id @default(cuid())
  name           String
  type           String
  address        String?
  phone          String?
  email          String?
  contact        String?
  website        String?
  description    String?
  representantId String?
  userId         String          @unique
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  orders         Order[]         @relation("PartnerOrders")
  representant   User?           @relation("PartnerRepresentant", fields: [representantId], references: [id])
  user           User            @relation(fields: [userId], references: [id])
  rebates        PartnerRebate[]
  stockItems     PartnerStock[]
  proformas      Proforma[]      @relation("PartnerProformas")
  rebateRates    RebateRate[]
  stockMovements StockMovement[]
}

model PartnerStock {
  id                String   @id @default(cuid())
  partnerId         String
  workId            String
  allocatedQuantity Int
  soldQuantity      Int      @default(0)
  returnedQuantity  Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  partner           Partner  @relation(fields: [partnerId], references: [id])
  work              Work     @relation(fields: [workId], references: [id])

  @@unique([partnerId, workId])
  @@index([partnerId])
  @@index([workId])
  @@index([createdAt])
}

model Order {
  id                 String              @id @default(cuid())
  userId             String
  partnerId          String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @default(now()) @updatedAt
  status             OrderStatus         @default(PENDING)
  paymentMethod      String?
  paymentReference   String?
  subtotal           Float               @default(0)
  tax                Float               @default(0)
  total              Float               @default(0)
  amountPaid         Float               @default(0)
  deliveryDate       DateTime?
  deliveryStatus     DeliveryStatus      @default(PENDING)
  depositAmount      Float?
  depositDate        DateTime?
  discount           Float               @default(0)
  fullPaymentDate    DateTime?
  monerooPaymentId   String?             @unique
  monerooStatus      String?
  paidAt             DateTime?
  paymentDueDate     DateTime?
  paymentStatus      PaymentStatus       @default(UNPAID)
  paymentType        PaymentType         @default(CASH)
  promoCode          String?
  receivedAt         DateTime?
  receivedBy         String?
  remainingAmount    Float               @default(0)
  deliveryNote       DeliveryNote?
  notificationChains NotificationChain[] @relation("NotificationChainOrders")
  partner            Partner?            @relation("PartnerOrders", fields: [partnerId], references: [id])
  user               User                @relation(fields: [userId], references: [id])
  items              OrderItem[]
  partnerRebates     PartnerRebate[]     @relation("OrderPartnerRebates")
  payments           Payment[]           @relation("OrderPayments")
  proforma           Proforma?           @relation("ProformaOrder")
  royalties          Royalty[]           @relation("OrderRoyalties")
  stockRequests      StockRequest[]      @relation("StockRequestOrders")

  @@index([promoCode])
  @@index([paymentType])
  @@index([paymentStatus])
  @@index([deliveryStatus])
  @@index([userId, status, createdAt])
  @@index([partnerId, status])
  @@index([status, createdAt])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([monerooPaymentId])
}

model OrderItem {
  id              String  @id @default(cuid())
  orderId         String
  workId          String
  quantity        Int
  price           Float
  isPriceOverride Boolean @default(false)
  originalPrice   Float?
  order           Order   @relation(fields: [orderId], references: [id])
  work            Work    @relation(fields: [workId], references: [id])

  @@index([orderId])
  @@index([workId])
}

model Payment {
  id               String   @id @default(cuid())
  orderId          String
  amount           Float
  paymentMethod    String
  paymentReference String?
  paymentDate      DateTime @default(now())
  notes            String?
  recordedById     String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  order            Order    @relation("OrderPayments", fields: [orderId], references: [id])
  recordedBy       User     @relation("RecordedPayments", fields: [recordedById], references: [id])

  @@index([orderId])
  @@index([paymentDate])
}

model DeliveryNote {
  id             String             @id @default(cuid())
  reference      String             @unique
  orderId        String             @unique
  generatedById  String
  validatedById  String?
  validatedAt    DateTime?
  controlledById String?
  controlledAt   DateTime?
  status         DeliveryNoteStatus @default(PENDING)
  period         String?
  notes          String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  motif          String?
  destination    String?
  etatLivres     String?
  transport      String?
  datePrevue     DateTime?
  controlledBy   User?              @relation("ControlledDeliveryNotes", fields: [controlledById], references: [id])
  generatedBy    User               @relation("GeneratedDeliveryNotes", fields: [generatedById], references: [id])
  order          Order              @relation(fields: [orderId], references: [id])
  validatedBy    User?              @relation("ValidatedDeliveryNotes", fields: [validatedById], references: [id])

  @@index([orderId])
  @@index([status])
  @@index([createdAt])
  @@index([reference])
}

model Proforma {
  id                 String                  @id @default(cuid())
  reference          String?                 @unique
  partnerId          String?
  userId             String?
  createdById        String
  status             ProformaStatus          @default(DRAFT)
  notes              String?
  version            Int                     @default(1)
  parentProformaId   String?
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  acceptedAt         DateTime?
  cancellationReason String?
  cancelledAt        DateTime?
  clientId           String?
  clientType         ProformaClientType?
  country            String                  @default("Gabon")
  currency           Currency                @default(FCFA)
  discountTotal      Float                   @default(0)
  issuedAt           DateTime                @default(now())
  orderId            String?                 @unique
  orderType          String?
  proformaNumber     String?                 @unique
  promoCode          String?
  promoDiscountRate  Float?
  subtotalHT         Float                   @default(0)
  taxableBase        Float                   @default(0)
  totalTTC           Float                   @default(0)
  tvaTotal           Float                   @default(0)
  validUntil         DateTime?
  createdBy          User                    @relation("CreatedProformas", fields: [createdById], references: [id])
  convertedToOrder   Order?                  @relation("ProformaOrder", fields: [orderId], references: [id])
  parentProforma     Proforma?               @relation("ProformaVersions", fields: [parentProformaId], references: [id])
  versions           Proforma[]              @relation("ProformaVersions")
  partner            Partner?                @relation("PartnerProformas", fields: [partnerId], references: [id])
  user               User?                   @relation("UserProformas", fields: [userId], references: [id])
  clientSnapshot     ProformaClientSnapshot?
  items              ProformaItem[]

  @@index([status])
  @@index([issuedAt])
  @@index([clientType, clientId])
  @@index([proformaNumber])
}

model ProformaItem {
  id           String    @id @default(cuid())
  proformaId   String
  workId       String?
  quantity     Int
  unitPrice    Float?
  discount     Float?    @default(0)
  total        Float?    @default(0)
  authorName   String?
  createdAt    DateTime  @default(now())
  discountRate Float     @default(0)
  isbn         String?
  lineDiscount Float     @default(0)
  lineHT       Float     @default(0)
  lineTVA      Float     @default(0)
  lineTaxable  Float     @default(0)
  reference    String?
  title        String?
  totalTTC     Float     @default(0)
  tvaRate      Float     @default(0.18)
  unitPriceHT  Float?
  updatedAt    DateTime? @updatedAt
  proforma     Proforma  @relation(fields: [proformaId], references: [id], onDelete: Cascade)
  work         Work?     @relation("ProformaItemWork", fields: [workId], references: [id])

  @@index([proformaId])
  @@index([workId])
}

model ProformaClientSnapshot {
  id         String   @id @default(cuid())
  proformaId String   @unique
  name       String
  email      String?
  phone      String?
  address    String?
  city       String?
  country    String?
  createdAt  DateTime @default(now())
  proforma   Proforma @relation(fields: [proformaId], references: [id], onDelete: Cascade)

  @@index([proformaId])
}

model StockRequest {
  id            String             @id @default(cuid())
  reference     String             @unique
  requestedById String
  approvedById  String?
  approvedAt    DateTime?
  status        StockRequestStatus @default(PENDING)
  type          StockRequestType
  method        String?
  period        String?
  deliveryDate  DateTime?
  departmentId  String?
  zoneId        String?
  orderId       String?
  notes         String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  approvedBy    User?              @relation("ApprovedStockRequests", fields: [approvedById], references: [id])
  order         Order?             @relation("StockRequestOrders", fields: [orderId], references: [id])
  requestedBy   User               @relation("StockRequests", fields: [requestedById], references: [id])
  items         StockRequestItem[]

  @@index([requestedById])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([reference])
}

model StockRequestItem {
  id               String       @id @default(cuid())
  requestId        String
  workId           String
  quantity         Int
  approvedQuantity Int?
  createdAt        DateTime     @default(now())
  request          StockRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  work             Work         @relation(fields: [workId], references: [id])

  @@index([requestId])
  @@index([workId])
}

model Royalty {
  id         String    @id @default(cuid())
  workId     String
  userId     String
  amount     Float
  paid       Boolean   @default(false)
  createdAt  DateTime  @default(now())
  approved   Boolean   @default(false)
  approvedAt DateTime?
  orderId    String?
  paidAt     DateTime?
  rate       Float?
  saleId     String?
  order      Order?    @relation("OrderRoyalties", fields: [orderId], references: [id])
  user       User      @relation(fields: [userId], references: [id])
  work       Work      @relation(fields: [workId], references: [id])

  @@index([userId])
  @@index([workId])
  @@index([orderId])
  @@index([paid])
  @@index([approved])
  @@index([createdAt])
  @@index([userId, paid, approved])
  @@index([workId, orderId])
}

model Withdrawal {
  id              String           @id @default(cuid())
  userId          String
  amount          Float
  method          WithdrawalMethod
  momoNumber      String?
  bankName        String?
  bankAccount     String?
  bankAccountName String?
  status          WithdrawalStatus @default(PENDING)
  requestedAt     DateTime         @default(now())
  validatedById   String?
  validatedAt     DateTime?
  paidAt          DateTime?
  rejectionReason String?
  notes           String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  momoProvider    String?
  user            User             @relation("AuthorWithdrawals", fields: [userId], references: [id])
  validatedBy     User?            @relation("ValidatedWithdrawals", fields: [validatedById], references: [id])

  @@index([userId])
  @@index([status])
  @@index([requestedAt])
}

model RepresentantWithdrawal {
  id              String           @id @default(cuid())
  userId          String
  amount          Float
  method          WithdrawalMethod
  momoNumber      String?
  bankName        String?
  bankAccount     String?
  bankAccountName String?
  status          WithdrawalStatus @default(PENDING)
  requestedAt     DateTime         @default(now())
  validatedById   String?
  validatedAt     DateTime?
  paidAt          DateTime?
  rejectionReason String?
  notes           String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  momoProvider    String?
  user            User             @relation("RepresentantWithdrawals", fields: [userId], references: [id])
  validatedBy     User?            @relation("ValidatedRepresentantWithdrawals", fields: [validatedById], references: [id])

  @@index([userId])
  @@index([status])
  @@index([requestedAt])
}

model PartnerRebate {
  id            String       @id @default(cuid())
  partnerId     String
  orderId       String?
  saleId        String?
  workId        String?
  amount        Float
  rate          Float
  status        RebateStatus @default(PENDING)
  validatedById String?
  validatedAt   DateTime?
  paidAt        DateTime?
  notes         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  order         Order?       @relation("OrderPartnerRebates", fields: [orderId], references: [id])
  partner       Partner      @relation(fields: [partnerId], references: [id])
  validatedBy   User?        @relation("ValidatedPartnerRebates", fields: [validatedById], references: [id])
  work          Work?        @relation("WorkPartnerRebates", fields: [workId], references: [id])

  @@index([partnerId])
  @@index([orderId])
  @@index([status])
  @@index([createdAt])
  @@index([workId])
}

model RebateRate {
  id          String         @id @default(cuid())
  type        RebateRateType
  partnerId   String?
  userId      String?
  workId      String?
  rate        Float
  isActive    Boolean        @default(true)
  startDate   DateTime?
  endDate     DateTime?
  createdById String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  createdBy   User           @relation("CreatedRebateRates", fields: [createdById], references: [id])
  partner     Partner?       @relation(fields: [partnerId], references: [id])
  user        User?          @relation("AuthorRebateRates", fields: [userId], references: [id])
  work        Work?          @relation("WorkRebateRates", fields: [workId], references: [id])

  @@unique([type, partnerId, userId, workId])
  @@index([type])
  @@index([partnerId])
  @@index([userId])
  @@index([workId])
  @@index([isActive])
}

model Message {
  id          String    @id @default(cuid())
  subject     String
  content     String
  type        String    @default("MESSAGE")
  read        Boolean   @default(false)
  readAt      DateTime?
  senderId    String
  recipientId String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  recipient   User      @relation("ReceivedMessages", fields: [recipientId], references: [id])
  sender      User      @relation("SentMessages", fields: [senderId], references: [id])
}

model Notification {
  id        String    @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String
  data      String?
  read      Boolean   @default(false)
  createdAt DateTime  @default(now())
  readAt    DateTime?
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@index([userId, read, createdAt])
  @@index([type, createdAt])
}

model NotificationTemplate {
  id          String   @id @default(cuid())
  code        String   @unique
  titre       String
  texte       String
  statut      String   @default("Actif")
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  updatedById String?
  createdBy   User     @relation("CreatedNotificationTemplates", fields: [createdById], references: [id])
  updatedBy   User?    @relation("UpdatedNotificationTemplates", fields: [updatedById], references: [id])

  @@index([code])
  @@index([statut])
  @@index([createdAt])
}

model NotificationChain {
  id            String   @id @default(cuid())
  title         String
  clientId      String?
  scheduledDate DateTime
  sendSMS       Boolean  @default(true)
  sendEmail     Boolean  @default(true)
  daysBefore    Int      @default(1)
  status        String   @default("Actif")
  message       String
  orderId       String?
  createdById   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  client        User?    @relation("NotificationChains", fields: [clientId], references: [id])
  createdBy     User     @relation("CreatedNotificationChains", fields: [createdById], references: [id])
  order         Order?   @relation("NotificationChainOrders", fields: [orderId], references: [id])

  @@index([clientId])
  @@index([status])
  @@index([scheduledDate])
  @@index([createdAt])
}

model AdvancedSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  description String
  value       String
  type        String   @default("string")
  category    String?
  status      String   @default("Actif")
  updatedById String?
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
  updatedBy   User?    @relation("UpdatedAdvancedSettings", fields: [updatedById], references: [id])

  @@index([key])
  @@index([category])
  @@index([status])
}

model WorkVersion {
  id            String    @id @default(cuid())
  workId        String
  version       String
  title         String
  description   String?
  isActive      Boolean   @default(true)
  publishedAt   DateTime?
  archivedAt    DateTime?
  createdBy     String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdByUser User      @relation(fields: [createdBy], references: [id])
  work          Work      @relation(fields: [workId], references: [id], onDelete: Cascade)

  @@index([workId])
  @@index([version])
  @@index([isActive])
}

model WorkSale {
  id         String   @id @default(cuid())
  workId     String
  quantity   Int
  amount     Float
  saleType   SaleType @default(DIRECT)
  customerId String?
  orderId    String?
  saleDate   DateTime @default(now())
  createdAt  DateTime @default(now())
  customer   User?    @relation(fields: [customerId], references: [id])
  work       Work     @relation(fields: [workId], references: [id], onDelete: Cascade)

  @@index([workId])
  @@index([saleDate])
  @@index([saleType])
}

model WorkDistribution {
  id               String           @id @default(cuid())
  workId           String
  quantity         Int
  distributionType DistributionType @default(SCHOOL)
  recipientId      String?
  recipientName    String?
  distributionDate DateTime         @default(now())
  notes            String?
  createdAt        DateTime         @default(now())
  work             Work             @relation(fields: [workId], references: [id], onDelete: Cascade)

  @@index([workId])
  @@index([distributionDate])
  @@index([distributionType])
}

model WorkView {
  id        String   @id @default(cuid())
  workId    String
  viewerId  String?
  ipAddress String?
  userAgent String?
  viewedAt  DateTime @default(now())
  viewer    User?    @relation(fields: [viewerId], references: [id])
  work      Work     @relation(fields: [workId], references: [id], onDelete: Cascade)

  @@index([workId])
  @@index([viewedAt])
  @@index([viewerId])
}

model StockAlertRule {
  id              String        @id @default(cuid())
  name            String
  description     String?
  type            AlertRuleType
  conditions      String
  actions         String
  isActive        Boolean       @default(true)
  priority        AlertPriority @default(MEDIUM)
  createdBy       String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  triggeredAlerts StockAlert[]  @relation("AlertRule")
  createdByUser   User          @relation(fields: [createdBy], references: [id])

  @@index([type])
  @@index([isActive])
  @@index([priority])
}

model StockAlert {
  id             String          @id @default(cuid())
  ruleId         String?
  workId         String?
  type           AlertType
  severity       AlertSeverity
  title          String
  message        String
  data           String?
  isRead         Boolean         @default(false)
  isResolved     Boolean         @default(false)
  resolvedBy     String?
  resolvedAt     DateTime?
  createdAt      DateTime        @default(now())
  resolvedByUser User?           @relation(fields: [resolvedBy], references: [id])
  rule           StockAlertRule? @relation("AlertRule", fields: [ruleId], references: [id])
  work           Work?           @relation(fields: [workId], references: [id])

  @@index([type])
  @@index([severity])
  @@index([isRead])
  @@index([isResolved])
  @@index([createdAt])
}

model StockReport {
  id            String            @id @default(cuid())
  name          String
  type          ReportType
  parameters    String
  schedule      String?
  isActive      Boolean           @default(true)
  lastRun       DateTime?
  nextRun       DateTime?
  createdBy     String
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  executions    ReportExecution[] @relation("Report")
  createdByUser User              @relation(fields: [createdBy], references: [id])

  @@index([type])
  @@index([isActive])
  @@index([nextRun])
}

model ReportExecution {
  id          String          @id @default(cuid())
  reportId    String
  status      ExecutionStatus
  startedAt   DateTime        @default(now())
  completedAt DateTime?
  result      String?
  error       String?
  filePath    String?
  report      StockReport     @relation("Report", fields: [reportId], references: [id])

  @@index([reportId])
  @@index([status])
  @@index([startedAt])
}

model StockIntegration {
  id            String          @id @default(cuid())
  name          String
  type          IntegrationType
  config        String
  isActive      Boolean         @default(true)
  lastSync      DateTime?
  syncStatus    SyncStatus      @default(PENDING)
  errorCount    Int             @default(0)
  lastError     String?
  createdBy     String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  createdByUser User            @relation(fields: [createdBy], references: [id])

  @@index([type])
  @@index([isActive])
  @@index([syncStatus])
}

model Promotion {
  id               String          @id @default(cuid())
  libelle          String
  code             String          @unique
  periode          String
  startDate        DateTime?
  endDate          DateTime?
  livre            String
  statut           PromotionStatus @default(ACTIF)
  taux             String
  quantiteMinimale Int             @default(1)
  description      String?
  createdBy        String
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  applyToAll       Boolean         @default(false)
  rateType         RateType        @default(PERCENTAGE)
  rateValue        Float?
  timeZone         String          @default("UTC")
  works            Work[]          @relation("WorkPromotions")

  @@index([code])
  @@index([statut])
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
  @@index([isActive])
}

model SchoolClass {
  id        String   @id @default(cuid())
  name      String   @unique
  section   String
  isActive  Boolean  @default(true)
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([section])
  @@index([isActive])
}

model Discount {
  id          String         @id @default(cuid())
  client      String
  livre       String
  quantiteMin Int            @default(1)
  reduction   Float
  statut      DiscountStatus @default(ACTIF)
  description String?
  type        String         @default("Montant")
  image       String?
  createdBy   String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([statut])
  @@index([client])
}

model Client {
  id             String       @id @default(cuid())
  nom            String
  telephone      String?
  email          String?
  address        String?
  city           String?
  contact        String?
  statut         ClientStatus @default(ACTIF)
  dette          Float        @default(0)
  notes          String?
  representantId String?
  totalOrders    Int          @default(0)
  totalSpent     Float        @default(0)
  lastOrder      DateTime?
  createdBy      String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  departmentId   String?
  type           ClientType   @default(particulier)
  department     Department?  @relation("DepartmentClients", fields: [departmentId], references: [id])
  users          User[]       @relation("UserDepartments")

  @@index([statut])
  @@index([type])
  @@index([representantId])
  @@index([email])
  @@index([createdAt])
  @@index([representantId, statut])
  @@index([departmentId])
}

model Communication {
  id             String              @id @default(cuid())
  title          String
  message        String
  type           CommunicationType   @default(ANNOUNCEMENT)
  targetAudience String
  status         CommunicationStatus @default(DRAFT)
  scheduledFor   DateTime?
  sentAt         DateTime?
  recipients     Int                 @default(0)
  readCount      Int                 @default(0)
  createdBy      String
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  @@index([status])
  @@index([type])
  @@index([createdAt])
}

model Setting {
  id        String   @id @default(cuid())
  category  String
  key       String
  value     String
  type      String   @default("string")
  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([category, key])
  @@index([category])
}

model AuditLog {
  id          String   @id @default(cuid())
  action      String
  userId      String?
  performedBy String
  details     String
  metadata    String?
  createdAt   DateTime @default(now())
  entityId    String?
  entityType  String?
  userEmail   String?
  userRole    String?

  @@index([createdAt])
  @@index([userId])
  @@index([action])
  @@index([createdAt, userId])
  @@index([createdAt, action])
  @@index([entityType])
}

model OtpCode {
  id        String   @id @default(cuid())
  email     String
  code      String
  type      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@unique([email, type])
  @@index([email, type])
}

model WorkPrice {
  id              String     @id @default(cuid())
  workId          String
  clientType      ClientType
  price           Float
  minimumQuantity Int        @default(1)
  work            Work       @relation("WorkPrices", fields: [workId], references: [id], onDelete: Cascade)

  @@unique([workId, clientType])
  @@index([workId])
}

model ClientTypeConfig {
  id                   String     @id @default(cuid())
  clientType           ClientType @unique
  label                String
  description          String?
  minimumOrderQuantity Int        @default(1)
  minimumOrderAmount   Float      @default(0)
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
}

enum RateType {
  PERCENTAGE
  AMOUNT
}

enum ClientType {
  particulier
  boutique
  grossiste
  ecole_contractuelle
  ecole_non_contractuelle
  partenaire
  bibliotheque
}

enum RoyaltyType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum WithdrawalMethod {
  MOMO
  BANK
  CASH
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
  CANCELLED
}

enum RebateStatus {
  PENDING
  VALIDATED
  PAID
  CANCELLED
}

enum RebateRateType {
  GLOBAL
  PARTNER
  AUTHOR
  WORK
}

enum Role {
  PDG
  REPRESENTANT
  CONCEPTEUR
  AUTEUR
  PARTENAIRE
  CLIENT
  INVITE
}

enum UserStatus {
  PENDING
  APPROVED
  REJECTED
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ProjectStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  ACCEPTED
  REJECTED
  APPROVED
  ARCHIVED
}

enum WorkStatus {
  DRAFT
  PENDING
  PUBLISHED
  REJECTED
  ON_SALE
  OUT_OF_STOCK
  DISCONTINUED
  SUSPENDED
  VALIDATED
}

enum OrderStatus {
  PENDING
  VALIDATED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentType {
  CASH
  DEPOSIT
  CREDIT
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum DeliveryStatus {
  PENDING
  PREPARING
  READY
  IN_TRANSIT
  DELIVERED
  RECEIVED
  FAILED
}

enum DeliveryNoteStatus {
  PENDING
  VALIDATED
  CONTROLLED
  COMPLETED
  CANCELLED
}

enum ProformaStatus {
  PENDING
  SENT
  AWAITING_RESPONSE
  ACCEPTED
  REJECTED
  CONVERTED
  CANCELLED
  DRAFT
  EXPIRED
}

enum ProformaClientType {
  ECOLE
  PARTENAIRE
  CLIENT
  INVITE
}

enum Currency {
  XOF
  XAF
  FCFA
}

enum StockRequestStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSING
  DELIVERED
  CANCELLED
}

enum StockRequestType {
  COMMANDE
  PRECOMMANDE
  DEPOT
  REAPPROVISIONNEMENT
}

enum StockMovementType {
  INBOUND
  OUTBOUND
  ADJUSTMENT
  TRANSFER
  DAMAGED
  EXPIRED
  PARTNER_ALLOCATION
  PARTNER_SALE
  PARTNER_RETURN
  DIRECT_SALE
  CORRECTION
  INVENTORY
}

enum SaleType {
  DIRECT
  ONLINE
  PARTNER
  SCHOOL
  BULK
}

enum DistributionType {
  SCHOOL
  LIBRARY
  PARTNER
  PROMOTION
  SAMPLE
}

enum AlertRuleType {
  STOCK_LOW
  STOCK_OUT
  SALES_THRESHOLD
  PRICE_CHANGE
  EXPIRY_WARNING
  CUSTOM
}

enum AlertPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AlertType {
  STOCK_LOW
  STOCK_OUT
  SALES_SPIKE
  PRICE_CHANGE
  EXPIRY_WARNING
  INTEGRATION_ERROR
  REPORT_FAILED
  CUSTOM
}

enum AlertSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

enum ReportType {
  INVENTORY_SUMMARY
  SALES_ANALYSIS
  STOCK_MOVEMENTS
  ALERTS_SUMMARY
  CUSTOM
}

enum ExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum IntegrationType {
  ORDER_SYSTEM
  ACCOUNTING_SYSTEM
  WAREHOUSE_SYSTEM
  ECOMMERCE_PLATFORM
  CUSTOM
}

enum SyncStatus {
  PENDING
  SYNCING
  SUCCESS
  FAILED
  DISABLED
}

enum PromotionStatus {
  ACTIF
  INACTIF
  EXPIRE
}

enum DiscountStatus {
  ACTIF
  INACTIF
}

enum ClientStatus {
  EN_ATTENTE
  ACTIF
  INACTIF
  SUSPENDU
}

enum CommunicationType {
  ANNOUNCEMENT
  NOTIFICATION
  PROMOTION
  POLICY
}

enum CommunicationStatus {
  DRAFT
  SCHEDULED
  SENT
  CANCELLED
}
